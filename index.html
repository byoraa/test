<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>투 두 리스트 - 단일 파일</title>
  <style>
    :root { --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#111827; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:720px;margin:32px auto;padding:20px}
    h1{margin:0 0 16px;font-size:28px}
    .row{display:flex;gap:8px}
    .input{flex:1;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#fff}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:hover{filter:brightness(0.98)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;align-items:center;margin:10px 0 8px}
    .seg{display:inline-flex;gap:6px;border:1px solid var(--line);border-radius:12px;padding:4px}
    .seg .chip{border:0;background:transparent;padding:6px 10px;border-radius:8px;cursor:pointer}
    .seg .chip.active{background:var(--accent);color:#fff}
    .search{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .muted{color:var(--muted);font-size:12px;margin-bottom:8px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:var(--card);box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .item .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .done .text{color:#94a3b8;text-decoration:line-through}
    .item .actions{display:flex;gap:6px;opacity:.7}
    .item .handle{cursor:grab;color:#94a3b8;padding:0 6px;user-select:none}
    .empty{padding:28px;text-align:center;border:1px dashed var(--line);border-radius:14px;color:#94a3b8;background:#fff}
    .editrow{display:grid;grid-template-columns:1fr auto;gap:8px}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    footer{margin-top:12px;color:#94a3b8;font-size:12px}
    @media (max-width:520px){ .item{grid-template-columns:auto 1fr auto} }
  </style>
</head>
<body>
  <div class="container">
    <h1>투 두 리스트</h1>

    <form id="addForm" class="row" autocomplete="off">
      <input id="newText" class="input" maxlength="500" placeholder="할 일을 입력하고 Enter" aria-label="할 일 입력" />
      <button class="btn primary" type="submit">추가</button>
    </form>

    <div class="toolbar">
      <div class="row" style="gap:8px">
        <button id="toggleAll" class="btn" aria-label="전체 토글">전체 토글</button>
        <button id="clearDone" class="btn" aria-label="완료 삭제">완료 삭제</button>
      </div>
      <div class="row" style="gap:8px;align-items:center">
        <div class="seg" role="tablist" aria-label="필터">
          <button class="chip active" data-filter="all" role="tab" aria-selected="true">전체</button>
          <button class="chip" data-filter="active" role="tab" aria-selected="false">미완료</button>
          <button class="chip" data-filter="done" role="tab" aria-selected="false">완료</button>
        </div>
        <input id="q" class="search" placeholder="검색" aria-label="검색" />
      </div>
    </div>

    <div id="counter" class="muted">남은 작업: 0개</div>

    <div id="list" class="list" role="list"></div>
    <div id="empty" class="empty" hidden>항목이 없습니다. 새로운 할 일을 추가해 보세요!</div>

    <div id="live" class="sr" aria-live="polite"></div>

    <footer>저장 위치: localStorage · 더블클릭으로 편집 · 드래그로 순서 변경</footer>
  </div>

  <script>
    const KEY = 'todoapp:v1:tasks.html';
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    // --- state ---
    let tasks = load();
    let ui = {
      list: $('#list'),
      empty: $('#empty'),
      counter: $('#counter'),
      live: $('#live'),
      filter: 'all',
      q: ''
    };

    function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)).toUpperCase(); }
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] } }
    function save(){ localStorage.setItem(KEY, JSON.stringify(tasks)); }

    // --- render ---
    function render(){
      const q = ui.q.trim().toLowerCase();
      const filtered = tasks.filter(t=>{
        if(ui.filter==='active' && t.done) return false;
        if(ui.filter==='done' && !t.done) return false;
        if(q && !t.text.toLowerCase().includes(q)) return false;
        return true;
      });
      ui.list.innerHTML = '';
      ui.empty.hidden = filtered.length !== 0;
      filtered.forEach((t,i)=> ui.list.appendChild(Item(t,i)) );
      ui.counter.textContent = `남은 작업: ${tasks.filter(t=>!t.done).length}개`;
      save();
    }

    // --- item element ---
    function Item(task, index){
      const row = document.createElement('div');
      row.className = 'item' + (task.done ? ' done' : '');
      row.setAttribute('role','listitem');
      row.draggable = true;
      row.dataset.id = task.id;

      const cb = document.createElement('input');
      cb.type='checkbox'; cb.checked=task.done; cb.ariaLabel='완료 토글';
      cb.addEventListener('change', ()=>{
        task.done = cb.checked;
        ui.live.textContent=`${cb.checked?'완료됨':'미완료로 변경'}: ${task.text}`;
        render();
      });

      const textBtn = document.createElement('button');
      textBtn.className='text'; textBtn.title='더블클릭으로 수정'; textBtn.textContent=task.text;
      textBtn.addEventListener('dblclick',()=>startEdit(task,row));

      const actions = document.createElement('div');
      actions.className='actions';
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='수정';
      edit.addEventListener('click',()=>startEdit(task,row));
      const del = document.createElement('button'); del.className='btn'; del.style.color='#dc2626'; del.textContent='삭제';
      del.addEventListener('click',()=>{
        tasks = tasks.filter(x=>x.id!==task.id);
        ui.live.textContent=`삭제됨: ${task.text}`;
        render();
      });
      const handle = document.createElement('span'); handle.className='handle'; handle.title='드래그로 순서 변경'; handle.textContent='⋮⋮';
      actions.append(edit, del, handle);

      // drag & drop
      row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', task.id); });
      row.addEventListener('dragover', e=>{ e.preventDefault(); });
      row.addEventListener('drop', e=>{
        e.preventDefault();
        const dragId = e.dataTransfer.getData('text/plain');
        const overId = task.id;
        if(!dragId || dragId===overId) return;
        const a = tasks.findIndex(t=>t.id===dragId);
        const b = tasks.findIndex(t=>t.id===overId);
        if(a<0||b<0) return;
        const [m] = tasks.splice(a,1);
        tasks.splice(b,0,m);
        render();
      });

      row.append(cb, textBtn, actions);
      return row;
    }

    function startEdit(task, row){
      const wrap = document.createElement('form');
      wrap.className='editrow';
      const input = document.createElement('input');
      input.className='input';
      input.value = task.text;
      input.maxLength = 500;
      const ok = document.createElement('button'); ok.className='btn primary'; ok.type='submit'; ok.textContent='저장';
      const cancel = document.createElement('button'); cancel.className='btn'; cancel.type='button'; cancel.textContent='취소';
      wrap.append(input, ok, cancel);
      row.replaceWith(wrap);
      input.focus(); input.selectionStart = input.value.length;

      wrap.addEventListener('submit', (e)=>{
        e.preventDefault();
        const v = input.value.trim(); if(!v) return;
        task.text = v; ui.live.textContent = '작업이 업데이트되었습니다.'; render();
      });
      cancel.addEventListener('click', render);
    }

    // --- handlers ---
    $('#addForm').addEventListener('submit', e=>{
      e.preventDefault();
      const box = $('#newText');
      const v = box.value.trim();
      if(!v) return;
      tasks.unshift({ id: uid(), text: v, done:false, createdAt: Date.now() });
      ui.live.textContent = `추가됨: ${v}`;
      box.value=''; box.focus();
      render();
    });

    $('#toggleAll').addEventListener('click', ()=>{
      const allDone = tasks.every(t=>t.done);
      tasks = tasks.map(t=>({ ...t, done: !allDone }));
      render();
    });

    $('#clearDone').addEventListener('click', ()=>{
      const count = tasks.filter(t=>t.done).length;
      tasks = tasks.filter(t=>!t.done);
      ui.live.textContent = `${count}개 완료 작업이 삭제되었습니다.`;
      render();
    });

    $$('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        $$('.chip').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        ui.filter = chip.dataset.filter;
        render();
      });
    });

    $('#q').addEventListener('input', e=>{ ui.q = e.target.value; render(); });

    // 초기 렌더
    render();
  </script>
</body>
</html>
