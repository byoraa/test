<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teachable Machine Image Model · Demo</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0f172a;            /* slate-900 */
      --bg2: #0b1224;           /* darker */
      --card:#0b1224;           
      --text:#e5e7eb;           /* gray-200 */
      --muted:#94a3b8;          /* slate-400 */
      --line:#1f2937;           /* slate-800 */
      --accent:#60a5fa;         /* blue-400 */
      --accent-2:#22d3ee;       /* cyan-400 */
      --ok:#34d399;             /* green-400 */
      --warn:#fbbf24;           /* amber-400 */
      --err:#f87171;            /* red-400 */
      --shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f8fafc;--bg2:#eef2ff;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--shadow:0 10px 30px rgba(2,6,23,.08)}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -20%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(1200px 600px at 120% 20%, rgba(34,211,238,.18), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    h1{font-size:20px;margin:0}
    .card{display:grid;grid-template-columns:1fr min(420px,40%);gap:18px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    @media (max-width:980px){ .card{grid-template-columns:1fr} }

    .stage{position:relative;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#000;min-height:220px}
    .stage canvas{display:block;width:100%;height:auto}
    .badge{position:absolute;left:12px;top:12px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;backdrop-filter: blur(6px)}
    .hud{position:absolute;right:12px;top:12px;display:flex;gap:6px}
    .hud .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(15,23,42,.65);border:1px solid rgba(255,255,255,.12)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .btn{appearance:none;cursor:pointer;border:1px solid var(--line);background:transparent;color:inherit;padding:10px 14px;border-radius:12px}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1224;border:0;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .switch input{accent-color:var(--accent)}

    .side{display:flex;flex-direction:column;gap:12px}
    .panel{border:1px solid var(--line);border-radius:14px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent)}
    .panel h2{margin:0 0 8px;font-size:14px;color:var(--muted);letter-spacing:.02em}

    .pred{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:8px;border-radius:10px}
    .pred.top{background:linear-gradient(180deg, rgba(96,165,250,.12), rgba(34,211,238,.08));}
    .bar{height:8px;border-radius:999px;background:rgba(148,163,184,.25);overflow:hidden}
    .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .pct{font-variant-numeric:tabular-nums;min-width:56px;text-align:right}

    .note{color:var(--muted);font-size:12px}
    footer{margin-top:18px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Teachable Machine Image Model</h1>
      </div>
      <div class="note">웹캠을 사용하려면 <strong>HTTPS</strong> 환경에서 열어주세요.</div>
    </header>

    <section class="card">
      <!-- LEFT: Webcam Stage -->
      <div>
        <div class="stage" id="stage">
          <div class="badge" id="status">대기 중</div>
          <div class="hud">
            <div class="pill" id="fps">FPS –</div>
            <div class="pill" id="size">200×200</div>
          </div>
          <!-- webcam canvas will mount here -->
        </div>
        <div class="controls">
          <button class="btn primary" id="btnStart" type="button">Start</button>
          <button class="btn" id="btnStop" type="button" disabled>Stop</button>
          <label class="switch"><input type="checkbox" id="flip" checked> 미러(좌우 반전)</label>
          <label class="switch"><input type="checkbox" id="envCam"> 후면 카메라 시도(모바일)</label>
          <label class="switch">해상도
            <select id="sizeSel" class="btn" style="padding:8px 10px">
              <option value="200">200</option>
              <option value="224">224</option>
              <option value="320">320</option>
            </select>
          </label>
        </div>
      </div>

      <!-- RIGHT: Predictions / Info -->
      <aside class="side">
        <div class="panel">
          <h2>예측 결과</h2>
          <div id="preds"></div>
        </div>
        <div class="panel">
          <h2>모델 정보</h2>
          <div class="note">
            이 페이지는 <a href="https://teachablemachine.withgoogle.com/" target="_blank" rel="noreferrer">Teachable Machine</a>으로 내보낸 이미지 분류 모델을 사용합니다.<br/>
            모델 URL: <code id="modelUrl">https://teachablemachine.withgoogle.com/models/d4MkkHFnX/</code>
          </div>
        </div>
      </aside>
    </section>

    <footer>
      <span>키보드: <kbd>Space</kbd> = Start/Stop</span>
      <span>Tip: iOS는 사파리에서만 카메라 사용이 안정적입니다.</span>
    </footer>
  </div>

  <!-- TFJS & Teachable Machine (official CDNs) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // === Configuration ===
    const URL = "https://teachablemachine.withgoogle.com/models/d4MkkHFnX/"; // <- 사용자 모델 URL

    // === State ===
    let model, webcam, maxPredictions = 0;
    let running = false;
    let lastFrameTime = performance.now();

    // === Elements ===
    const statusEl = document.getElementById('status');
    const fpsEl = document.getElementById('fps');
    const sizeEl = document.getElementById('size');
    const stageEl = document.getElementById('stage');
    const predsEl = document.getElementById('preds');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const flipChk = document.getElementById('flip');
    const envCamChk = document.getElementById('envCam');
    const sizeSel = document.getElementById('sizeSel');
    document.getElementById('modelUrl').textContent = URL;

    // === Helpers ===
    function setStatus(text, tone){
      statusEl.textContent = text;
      statusEl.style.background = tone === 'ok' ? 'rgba(16,185,129,.85)'
        : tone === 'warn' ? 'rgba(245,158,11,.85)'
        : tone === 'err' ? 'rgba(239,68,68,.85)'
        : 'rgba(0,0,0,.55)';
    }

    function cls(node){ while(node.firstChild) node.removeChild(node.firstChild); }

    function renderPredictions(list){
      cls(predsEl);
      if(!list || !list.length){
        const p = document.createElement('div');
        p.className='note';
        p.textContent='예측 대기 중… Start를 눌러 주세요.';
        predsEl.appendChild(p);
        return;
      }
      // sort by prob desc
      list.sort((a,b)=> b.probability - a.probability);
      list.forEach((p, i)=>{
        const row = document.createElement('div');
        row.className = 'pred' + (i===0 ? ' top' : '');

        const left = document.createElement('div');
        left.style.display='grid';
        left.style.gridTemplateColumns='1fr';
        left.style.gap='8px';

        const label = document.createElement('div');
        label.textContent = p.className;

        const bar = document.createElement('div');
        bar.className='bar';
        const span = document.createElement('span');
        span.style.width = `${Math.round(p.probability*100)}%`;
        bar.appendChild(span);

        left.append(label, bar);

        const pct = document.createElement('div');
        pct.className='pct';
        pct.textContent = (p.probability*100).toFixed(1) + '%';

        row.append(left, pct);
        predsEl.appendChild(row);
      });
    }

    function updateFPS(){
      const now = performance.now();
      const dt = now - lastFrameTime;
      lastFrameTime = now;
      const fps = Math.max(1, Math.min(120, Math.round(1000/dt)));
      fpsEl.textContent = `FPS ${fps}`;
    }

    async function loadModel(){
      const modelURL = URL + 'model.json';
      const metadataURL = URL + 'metadata.json';
      setStatus('모델 로딩 중…', 'warn');
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
      setStatus('모델 준비 완료', 'ok');
    }

    async function setupWebcam(){
      const size = parseInt(sizeSel.value, 10) || 200;
      const flip = !!flipChk.checked;
      sizeEl.textContent = `${size}×${size}`;

      // If a webcam already exists, stop and remove it first
      if(webcam){
        try{ webcam.stop(); }catch(e){}
        try{ stageEl.removeChild(webcam.canvas); }catch(e){}
      }

      webcam = new tmImage.Webcam(size, size, flip);

      // On some devices it's helpful to hint facingMode
      const useEnv = envCamChk.checked;
      const constraints = useEnv ? { facingMode: { exact: 'environment' } } : { facingMode: 'user' };

      setStatus('카메라 요청 중…', 'warn');
      try{
        await webcam.setup(constraints); // ask for camera permissions
      }catch(err){
        console.error(err);
        setStatus('카메라 접근 거부 또는 오류', 'err');
        throw err;
      }

      await webcam.play();
      stageEl.appendChild(webcam.canvas);
      setStatus('예측 중…', 'ok');
    }

    async function predict(){
      if(!model || !webcam) return;
      webcam.update();
      const prediction = await model.predict(webcam.canvas);
      updateFPS();
      renderPredictions(prediction);
    }

    async function loop(){
      if(!running) return;
      await predict();
      requestAnimationFrame(loop);
    }

    async function start(){
      if(running) return;
      btnStart.disabled = true; btnStop.disabled = false;
      try{
        if(!model) await loadModel();
        await setupWebcam();
        running = true;
        loop();
      }catch(err){
        btnStart.disabled = false; btnStop.disabled = true;
        alert('실행 중 오류가 발생했습니다. HTTPS 환경인지, 카메라 권한이 허용되었는지 확인해 주세요.\n\nConsole을 열어 상세 로그를 확인하세요.');
      }
    }

    function stop(){
      running = false;
      try{ webcam && webcam.stop(); }catch(e){}
      btnStart.disabled = false; btnStop.disabled = true;
      setStatus('중지됨', 'warn');
    }

    // === Wire up UI ===
    btnStart.addEventListener('click', start);
    btnStop.addEventListener('click', stop);
    sizeSel.addEventListener('change', ()=>{ if(running) start(); });
    flipChk.addEventListener('change', ()=>{ if(running) start(); });
    envCamChk.addEventListener('change', ()=>{ if(running) start(); });
    document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); running? stop(): start(); }});

    // Initial render for prediction
